<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>企业工资管理系统 - 净工资概览</title>
  <!-- Bootstrap CSS -->
  <link href="{% static 'bootstrap5/bootstrap.min.css' %}" rel="stylesheet">
  <style>
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #333;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      opacity: 1;
      transition: opacity 0.5s ease-in-out;
    }
    #salary-chart {
      height: 400px;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'bootstrap5/bootstrap.bundle.min.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <header class="navbar navbar-expand-md navbar-light bg-light mb-4">
    <div class="container-fluid">
      <a href="/" class="navbar-brand">企业工资管理系统</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="切换导航">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a href="{% url 'salary:grosssalary' %}" class="nav-link">毛工资概览</a>
          </li>
          <li class="nav-item">
            <a href="{% url 'salary:netsalary' %}" class="nav-link active">净工资概览</a>
          </li>
        </ul>
      </div>
    </div>
  </header>

  <!-- 主要内容区 -->
  <main class="container mt-5">
    <h1 class="mb-4">净工资概览</h1>
    
    <form method="post" onsubmit="onSubmit(event)" class="mb-3">
      {% csrf_token %}
      <div class="input-group">
        <input type="month" id="year_month" name="year_month" value="{{ selected_year_month|default_if_none:'2024-01' }}" class="form-control">
        <button type="submit" class="btn btn-primary">查询</button>
        <button type="submit" class="btn btn-success">重新计算并展示当月工资</button>
      </div>
      <input type="hidden" name="action" value="query">
      <input type="hidden" name="action" value="calculate">
    </form>

    {% if avg_netsalary is not None %}
    <p>平均净工资: {{ avg_netsalary }}</p>
    {% endif %}

    <canvas id="salary-chart"></canvas>

    <table class="table table-striped table-hover mt-4">
      <thead class="table-dark">
        <tr>
          <th scope="col">员工ID</th>
          <th scope="col">姓名</th>
          <th scope="col">基本工资</th>
          <th scope="col">缺勤扣款</th>
          <th scope="col">加班费</th>
          <th scope="col">绩效奖金</th>
          <th scope="col">年终奖</th>
          <th scope="col">五险一金</th>
          <th scope="col">个人所得税</th>
          <th scope="col">净工资</th>
        </tr>
      </thead>
      <tbody>
        {% for salary in salaries %}
        <tr>
          <td>{{ salary.employeeid }}</td>
          <td>{{ salary.name }}</td>
          <td>{{ salary.basesalary }}</td>
          <td>{{ salary.absentdeduction }}</td>
          <td>{{ salary.overtimepay }}</td>
          <td>{{ salary.performancebonus }}</td>
          <td>{{ salary.yearendbonus }}</td>
          <td>{{ salary.socialsecurityandhousingfund }}</td>
          <td>{{ salary.incometax }}</td>
          <td>{{ salary.netsalary }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </main>

  <script>
    function onSubmit(event) {
      event.preventDefault();
      var form = document.querySelector('form');
      var action = event.submitter.classList.contains('btn-success') ? "calculate" : "query";
      form.querySelector('input[name="action"]').value = action;
      form.setAttribute("method", action === "calculate" ? "post" : "get");
      form.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
      const ctx = document.getElementById('salary-chart').getContext('2d');
      const chartData = JSON.parse('{{ chart_data|safe }}');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
          datasets: chartData
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });

      // 显示通知的方法
      function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'toast';
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 500); // 等待动画结束再移除
        }, 3000); // 3秒后自动关闭通知
      }

      // 处理表单提交后的通知（如果有）
      {% if messages %}
        {% for message in messages %}
          showNotification('{{ message }}');
        {% endfor %}
      {% endif %}
    });
  </script>
</body>
</html>